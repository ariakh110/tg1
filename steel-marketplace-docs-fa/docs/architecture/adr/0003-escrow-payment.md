# ADR-0003: طراحی پرداخت با «حساب امن (Escrow)» و دفترکل داخلی (Ledger)

- **وضعیت:** پذیرفته‌شده (Accepted)
- **تاریخ:** 2026-01-02

## زمینه (Context)

پرداخت‌ها در این پلتفرم:

- مبالغ بالا دارند.
- مرحله‌ای هستند (deposit + اقساط + تسویه نهایی بر اساس وزن).
- چند ذینفع دارند (فروشنده، برشکار، راننده، QC).
- نیازمند اعتمادسازی هستند: خریدار می‌خواهد مطمئن شود پول بدون تحویل/تکمیل آزاد نمی‌شود.

## تصمیم (Decision)

- تمام پرداخت‌های آنلاین در سیستم به شکل `Payment` ثبت می‌شوند.
- پس از موفقیت پرداخت، پول به صورت منطقی وارد **حساب امن پلتفرم** می‌شود و در `LedgerEntry` ثبت می‌گردد.
- آزادسازی وجه (payout) به فروشنده/خدمت‌دهنده فقط پس از رسیدن به رویدادهای تعریف‌شده انجام می‌شود:
  - کالا: پس از تسویه نهایی + تأیید تحویل (یا پس از بازه زمانی بدون dispute)
  - خدمات: پس از علامت‌گذاری تکمیل + تأیید خریدار
- کارمزد پلتفرم در زمان payout کسر می‌شود و به عنوان `LedgerEntry` جداگانه ثبت می‌گردد.
- برگشت وجه (refund) نیز با ledger ثبت می‌شود.

## دلایل (Rationale)

- ledger ساده به ما اجازه می‌دهد:
  - گزارش‌گیری دقیق و ممیزی‌پذیر داشته باشیم.
  - در صورت چند تراکنش پرداختی، مجموع قابل اتکا باشد.
  - از double-release یا double-refund جلوگیری کنیم (با idempotency)

## پیامدها (Consequences)

### مثبت
- افزایش اعتماد کاربران
- امکان پیاده‌سازی پرداخت مرحله‌ای و مدیریت اختلافات
- سازگاری با محدودیت‌های بانکی (چند پرداخت کوچک)

### منفی / ریسک‌ها
- پیاده‌سازی مالی و قوانین آزادسازی پیچیده‌تر می‌شود.
- نیازمند idempotency و transaction boundary دقیق است.
- در برخی پرداخت‌یارها، «نگهداشت واقعی پول» ممکن است محدود باشد و ما فقط «نگهداشت منطقی» انجام می‌دهیم.
  - **راه‌حل:** در MVP escrow منطقی + تسویه دوره‌ای؛ در فاز بعد split-settlement یا راهکارهای بانکی بررسی شود.

## گزینه‌های بررسی‌شده (Alternatives)

- پرداخت مستقیم به فروشنده/مجری (بدون escrow): ساده، اما اعتماد پایین و ریسک بالا
- کیف پول کامل (Wallet) از ابتدا: قدرتمند، اما زمان توسعه زیاد و مقررات پیچیده‌تر

## ارجاع‌ها

- معماری: `docs/architecture/architecture.md`
