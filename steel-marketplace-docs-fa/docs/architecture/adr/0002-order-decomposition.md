# ADR-0002: مدل‌سازی سفارش‌ها به صورت Order عمومی + زیرسفارش (Composite)

- **وضعیت:** پذیرفته‌شده (Accepted)
- **تاریخ:** 2026-01-02

## زمینه (Context)

پلتفرم چند نوع سفارش دارد: BUY/SELL/CUT/SHIP/QC و همچنین سفارش ترکیبی (COMBO).
نیاز داریم:

- بتوانیم یک سفارش اصلی داشته باشیم که چند فعالیت زیرمجموعه را پوشش دهد (خرید + برش + حمل + QC).
- وضعیت هر بخش را جداگانه پیگیری کنیم.
- پرداخت‌ها و پیشنهادها را برای هر بخش مستقل نگه داریم.
- در MVP هم ساده شروع کنیم و به‌تدریج پیچیدگی را اضافه کنیم.

## تصمیم (Decision)

از یک مدل اصلی به نام `Order` استفاده می‌کنیم با:

- فیلد `type` (BUY/SELL/CUT/SHIP/QC/COMBO)
- فیلد `parent_order` (self-relation) برای ایجاد **زیرسفارش‌ها**
- فیلد `assigned_provider` برای نگهداری مجری/فروشنده انتخاب‌شده
- پیشنهادها (`Offer`) به `Order` متصل هستند
- پرداخت‌ها (`Payment`) به همان `Order` یا زیرسفارش متصل هستند

در این مدل:

- سفارش COMBO صرفاً نقش «کانتینر» دارد و معمولاً پرداخت/پیشنهاد مستقیم ندارد (اما می‌تواند در آینده داشته باشد).
- زیرسفارش‌ها قابل ایجاد دستی یا خودکار (در فازهای بعد) هستند.

## دلایل (Rationale)

- یک مدل واحد Queryها را ساده‌تر می‌کند (لیست سفارش‌ها، فیلتر بر اساس type/status).
- مدیریت چرخه عمر و گزارش‌گیری آسان‌تر است.
- امکان توسعه تدریجی: ابتدا BUY/SELL و خدمات جداگانه؛ سپس COMBO و ایجاد خودکار child orders.

## پیامدها (Consequences)

### مثبت
- انعطاف‌پذیری بالا
- کاهش تعداد مدل‌ها و APIهای موازی
- قابلیت اضافه کردن نوع سفارش جدید بدون تغییر شدید

### منفی / ریسک‌ها
- برخی فیلدها فقط برای بعضی typeها معنا دارند (nullable fields).
  - **راه‌حل:** Validation سطح Serializer/Service بر اساس type
- پیچیدگی قوانین انتقال وضعیت: هر type قواعد خودش را دارد.
  - **راه‌حل:** State machine مرکزی + per-type rules (ADR-0004)

## گزینه‌های بررسی‌شده (Alternatives)

1) مدل جداگانه برای هر نوع سفارش (PurchaseOrder/CuttingOrder/...)
- مزیت: فیلدها تمیزتر
- عیب: API و queryها پیچیده‌تر، migration سخت‌تر، polymorphism

2) مدل Order + مدل‌های Detail جدا (Order + PurchaseDetail + ShippingDetail)
- گزینه خوب در فازهای بعد برای نرمال‌سازی، اما در MVP هزینه توسعه بیشتر

## ارجاع‌ها

- معماری: `docs/architecture/architecture.md`
- ADR ماشین حالت: `docs/architecture/adr/0004-order-state-machine.md`
